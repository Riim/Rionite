<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>

	<style>

todo {
	display: block;
}

todo._done .todo__text {
	text-decoration: line-through;
}

	</style>
</head>
<body>

<todo-app></todo-app>

<script src="../rista.js"></script>
<script type="text/ecmascript-7">

let d = rista.d;

let idCounter = 0;

function nextId() {
	return String(++idCounter);
}

let appModel = {
	@d.observable todos: rista.map({
		[nextId()]: { text: 'Сходить в магаз', @d.observable done: false },
		[nextId()]: { text: 'Накормить кота', @d.observable done: false },
		[nextId()]: { text: 'Убить Билла', @d.observable done: true }
	}),

	@d.computed doneTodoCount: function() {
		let count = 0;

		this.todos.forEach(todo => {
			if (todo.done) {
				count++;
			}
		});

		return count;
	}
};

rista.component('todo', {
	preinit() {
		this.model = appModel.todos.get(this.block.dataset.id);
	},

	renderInner() {
		let model = this.model;

		return `
			<input class="todo__cbDone" type="checkbox" rt-change="_onCbDoneChange" ${model.done ? 'checked' : ''}>
			<span class="todo__text">${model.text}</span>
			<button rt-click="_onBtnRemoveClick">remove</button>
		`;
	},

	init() {
		if (this.model.done) {
			this.block.classList.add('_done');
		}
	},

	_onCbDoneChange(evt) {
		let done = evt.target.checked;

		appModel.todos.get(this.block.dataset.id).done = done;

		if (done) {
			this.block.classList.add('_done');
		} else {
			this.block.classList.remove('_done');
		}
	},

	_onBtnRemoveClick() {
		appModel.todos.delete(this.block.dataset.id);
	}
});

rista.component('todo-app', {
	renderInner() {
		let t = [];

		appModel.todos.forEach((todo, key) => {
			t.push(`<todo data-id="${key}"></todo>`);
		});

		return `
			${t.join('')}
			<input class="todoApp__tfNewTodo" type="text">
			<button rt-click="_onBtnAddClick">Add #${appModel.todos.size + 1}</button>
			<div>all: ${appModel.todos.size} done: ${appModel.doneTodoCount}</div>
		`;
	},

	_onBtnAddClick() {
		let value = this.$('&__tfNewTodo')[0].value;

		appModel.todos.set(nextId(), {
			text: value,
			@d.observable done: false
		});
	}
});

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.32/browser.min.js"></script>
<script>

Array.prototype.forEach.call(document.querySelectorAll('script[type="text/ecmascript-7"]'), function(script) {
	babel.run(script.innerHTML, {
		optional: ['es7.classProperties', 'es7.decorators', 'es7.functionBind']
	});
});

</script>

</body>
</html>
